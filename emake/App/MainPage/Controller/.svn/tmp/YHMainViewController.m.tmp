//
//  YHMainViewController.m
//  emake
//
//  Created by 谷伟 on 2018/3/16.
//  Copyright © 2018年 emake. All rights reserved.
//

#import "YHMainViewController.h"
#import "SDCycleScrollView.h"
#import "YHMainPageCategoryCell.h"
#import "MainPageLastWeekCell.h"
#import "YHMainShoppingModel.h"
#import "YHProductClassifyViewController.h"
#import "YHMainMessageCenterViewController.h"
#import "ChatNewViewController.h"
#import "YHBrandQulificationViewController.h"
#import "YHCertificationStateOriginalViewController.h"
#import "YHCertificationStateViewController.h"
#import "YHInsuranceSeviceViewController.h"
#import "YHAfterServersViewController.h"
#import "YHLoginViewController.h"
#import "YHTodayPriceViewController.h"
#import "HRAdView.h"
#import "YHCertificationSuccessViewController.h"
#import "YHScanViewController.h"
#import "YHMainChooseCatagoryViewController.h"
#import "YHCommonWebViewController.h"
#import "YHDiscoverViewController.h"
@interface YHMainViewController ()<UICollectionViewDelegate,UICollectionViewDataSource,SDCycleScrollViewDelegate,YHAlertViewDelegete>
{
    NSString *phone;
}
@property (nonatomic,retain)NSMutableArray *dataArray;
@property (nonatomic,retain)UICollectionView *collectionView;
@property (nonatomic,strong)UILabel *labelTotal;
@property (nonatomic,strong)UITableView *lastWeekTableView;
@property (nonatomic,copy)NSString *all_Prices;
@property(nonatomic,strong)NSMutableArray *lastOrderArray;
@property(nonatomic,retain)NSMutableArray *CategoryData;
@property(nonatomic,retain)NSMutableArray *CategoryCode;
@property(nonatomic,retain)UIView *categoryView;
@property(nonatomic,retain)UIView *viewLastWeek;
@property(nonatomic,retain)NSDictionary *category;
@property(nonatomic,retain)NSMutableArray *bannerImageGroup;
@property(nonatomic,retain)NSMutableArray *bannerInstuition;
@property(nonatomic,retain)NSMutableArray *commpanyServersArray;
@property(nonatomic,retain)SDCycleScrollView *cycleview;
@property(nonatomic,retain)UIButton *brandButton;
@property(nonatomic,retain)UIButton *qualityButton;
@property(nonatomic,retain)UIButton *afterSaleButton;
@property(nonatomic,retain)UIView *commpanyServersView;
@end

@implementation YHMainViewController
- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    self.navigationItem.leftBarButtonItem = nil;
    phone = [[NSUserDefaults standardUserDefaults] objectForKey:LOGIN_MOBILEPHONE];

    [self.navigationController setNavigationBarHidden:YES animated:NO];
    NSInteger messageCount = [YHMQTTClient sharedClient].MessageCount;
    UIImageView *serverImage = (UIImageView *)[self.serverView viewWithTag:100];
    UIImageView *infomationImage = (UIImageView *)[self.infomationView viewWithTag:100];
    if (messageCount>0) {
        if (messageCount>99){
            messageCount = 99;
        }
        [serverImage showBadgeWithStyle:WBadgeStyleNumber value:messageCount animationType:WBadgeAnimTypeNone];
        serverImage.badgeCenterOffset = CGPointMake(WidthRate(-8), HeightRate(5));
    }else{
        [serverImage clearBadge];
    }
    NSInteger eventCount = [YHMQTTClient sharedClient].EventCount;
    if (eventCount>0) {
        if (eventCount>99){
            eventCount = 99;
        }
        [infomationImage showBadgeWithStyle:WBadgeStyleNumber value:eventCount animationType:WBadgeAnimTypeNone];
        infomationImage.badgeCenterOffset = CGPointMake(WidthRate(-8), HeightRate(5));
        
    }else{
        [infomationImage clearBadge];
    }
    [self getMainPageAdd];
    [self getCateGoryData];
    [self getLastWeekData];
    [self getCommpanyServerData];
}
- (void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:animated];
    [self.navigationController setNavigationBarHidden:YES animated:NO];
}
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.view.backgroundColor = TextColor_F5F5F5;
    [self configSubViews];
    self.CategoryData = [NSMutableArray arrayWithObjects:@"输配电",@"电机",@"家具",@"灯具",@"休闲食品",nil];
    self.CategoryCode = [NSMutableArray arrayWithObjects:@"001-001",@"001-002",@"002-001",@"002-002",@"002-003",nil];
    self.bannerImageGroup = [[NSMutableArray alloc]initWithCapacity:0];
    self.bannerInstuition = [[NSMutableArray alloc]initWithCapacity:0];

    phone = [[NSUserDefaults standardUserDefaults] objectForKey:LOGIN_MOBILEPHONE];

    if (phone.length <= 0) {
            YHMainChooseCatagoryViewController *choose = [[YHMainChooseCatagoryViewController alloc] init];
            choose.navigationController.navigationBarHidden = YES;
            choose.hidesBottomBarWhenPushed =YES;
            [self.navigationController pushViewController:choose animated:NO];
    }else{
        BOOL isValide =  [NSDate isValideTimeDifferenceWithLastLoginTime:[[NSUserDefaults standardUserDefaults] objectForKey:LOGIN_TIME] currentLoginTime:[NSDate getCurrentTime] ValidTime:LOGIN_VALID];
        if (isValide == NO) {
            YHLoginViewController *loginViewController = [[YHLoginViewController alloc] init];
            loginViewController.navigationController.navigationBarHidden = YES;
            loginViewController.hidesBottomBarWhenPushed =YES;
            [self.navigationController pushViewController:loginViewController animated:NO];
        }
    }
}
- (UIView *)getPictureWithTextViewWithTag:(NSInteger)tag andText:(NSString *)text imageString:(NSString *)imageString{
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, WidthRate(33), WidthRate(45))];
    UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom];
    [button addTarget:self action:@selector(goSelectVC:) forControlEvents:UIControlEventTouchUpInside];
    button.tag = tag;
    [view addSubview:button];
    
    [button mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(0);
        make.right.mas_equalTo(0);
        make.bottom.mas_equalTo(0);
        make.top.mas_equalTo(0);
    }];
    
    UIImageView *image = [[UIImageView alloc]initWithImage:[UIImage imageNamed:imageString]];
    image.contentMode = UIViewContentModeScaleAspectFit;
    image.tag = 100;
    [view addSubview:image];
    
    [image mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(WidthRate(0));
        make.centerX.mas_equalTo(view.mas_centerX);
        make.width.mas_equalTo(30);
        make.height.mas_equalTo(30);
    }];
    
    UILabel *label = [[UILabel alloc]init];
    label.text = text;
    label.font = SYSTEM_FONT(AdaptFont(9));
    [view addSubview:label];
    
    [label mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(view.mas_centerX);
        make.top.mas_equalTo(image.mas_bottom).offset(WidthRate(-4));
    }];
    return view;
}
- (void)configSubViews{
    
    self.cycleview = [SDCycleScrollView cycleScrollViewWithFrame:CGRectMake(0, -(TOP_BAR_HEIGHT), ScreenWidth, HeightRate(250)) delegate:self placeholderImage:[UIImage imageNamed:@""]];
    [self.view addSubview:self.cycleview];
    
    [self.cycleview mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(0);
        make.right.mas_equalTo(0);
        make.top.mas_equalTo(0);
        make.height.mas_equalTo(HeightRateCommon(250));
    }];
    
    self.categoryView = [self getPictureWithTextViewWithTag:1 andText:@"扫一扫" imageString:@"saomiao"];
    [self.view addSubview:self.categoryView];
    
    
    [self.categoryView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo((StatusBarHEIGHT)-3);
        make.left.mas_equalTo(WidthRate(9));
        make.width.mas_equalTo(WidthRate(35));
        make.height.mas_equalTo(HeightRateCommon(50));
    }];
    
    
    self.infomationView = [self getPictureWithTextViewWithTag:2 andText:@"消息" imageString:@"xiaoxi1"];
    [self.view addSubview:self.infomationView];
    
    [self.infomationView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo((StatusBarHEIGHT)-3);
        make.right.mas_equalTo(WidthRate(-9));
        make.width.mas_equalTo(WidthRate(23));
        make.height.mas_equalTo(HeightRateCommon(30));
    }];
    
    
    self.serverView = [self getPictureWithTextViewWithTag:3 andText:@"客服" imageString:@"shouyekefu"];
    [self.view addSubview:self.serverView];
    
    [self.serverView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo((StatusBarHEIGHT)-3);
        make.right.mas_equalTo(self.infomationView.mas_left).offset(WidthRate(-9));
        make.width.mas_equalTo(WidthRate(23));
        make.height.mas_equalTo(HeightRateCommon(30));
    }];
    
    
    UICollectionViewFlowLayout *layout = [[UICollectionViewFlowLayout alloc] init];
    
    self.collectionView = [[UICollectionView alloc] initWithFrame:CGRectZero collectionViewLayout:layout];
    self.collectionView.translatesAutoresizingMaskIntoConstraints = NO;
    self.collectionView.backgroundColor = [UIColor whiteColor];
    self.collectionView.scrollEnabled = NO;
    self.collectionView.delegate = self;
    self.collectionView.dataSource = self;
    [self.view addSubview:self.collectionView];
    [self.collectionView registerClass:[YHMainPageCategoryCell class] forCellWithReuseIdentifier:@"MainPageCategoryCell"];
    [self.collectionView registerClass:[UICollectionViewCell class] forCellWithReuseIdentifier:@"LsatCategoryCell"];
    [self.collectionView registerClass:[UICollectionReusableView class] forSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:@"header"];
    [self.collectionView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(0);
        make.right.mas_equalTo(0);
        make.top.mas_equalTo(self.cycleview.mas_bottom);
        make.height.mas_equalTo(HeightRate(165));
    }];
    
    
    UIView *sepacialView = [[UIView alloc]init];
    sepacialView.backgroundColor = RGBColor(219, 227, 234);//[UIColor whiteColor];
    [self.view addSubview:sepacialView];
    
    [sepacialView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(0);
        make.right.mas_equalTo(0);
        make.top.mas_equalTo(self.collectionView.mas_bottom).offset(HeightRate(5));
        make.height.mas_equalTo(HeightRate(40));
    }];
    
    [self specilView:sepacialView tiltle:@"特殊产品" othertiltle:@"实时报价" imageName:@"teshupinxunjia" isRight:NO];
    [self specilView:sepacialView tiltle:@" 发 现 " othertiltle:@"最新资讯" imageName:@"faxians" isRight:YES];
 
    self.commpanyServersView = [[UIView alloc]init];
    [self.view addSubview:self.commpanyServersView];
    
    [self.commpanyServersView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(0);
        make.right.mas_equalTo(0);
        make.height.mas_equalTo(HeightRate(54));
        make.top.mas_equalTo(sepacialView.mas_bottom);
    }];
    
    
    self.viewLastWeek = [[UIView alloc]init];
    self.viewLastWeek.backgroundColor = [UIColor whiteColor];
    [self.view addSubview:self.viewLastWeek];
    
    [self.viewLastWeek mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(0);
        make.right.mas_equalTo(0);
        make.top.mas_equalTo(self.commpanyServersView.mas_bottom);
        make.height.mas_equalTo(HeightRate(31));
    }];
    
    UIImageView *orderImage = [[UIImageView alloc]initWithImage:[UIImage imageNamed:@"orderEmpty"]];
    [self.viewLastWeek addSubview:orderImage];
    
    [orderImage mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(WidthRate(25));
        make.width.mas_equalTo(WidthRate(18));
        make.height.mas_equalTo(WidthRate(18));
        make.centerY.mas_equalTo(self.viewLastWeek.centerY);
    }];
    
    UILabel *labelTitle = [[UILabel alloc]init];
    labelTitle.text = @"上周订单";
    labelTitle.font = [UIFont systemFontOfSize:AdaptFont(13)];
    [self.viewLastWeek addSubview:labelTitle];
    
    [labelTitle mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(orderImage.mas_right).offset(WidthRate(10));
        make.centerY.mas_equalTo(self.viewLastWeek.centerY);
    }];
    
    self.labelTotal = [[UILabel alloc]init];
    self.labelTotal.font = [UIFont systemFontOfSize:AdaptFont(12)];
    self.labelTotal.textColor = [UIColor blackColor];
    [self.viewLastWeek addSubview:self.labelTotal];
    
    [self.labelTotal mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_equalTo(WidthRate(-10));
        make.centerY.mas_equalTo(self.viewLastWeek.centerY);
    }];
    
    UILabel *line = [[UILabel alloc]init];
    line.backgroundColor = SepratorLineColor;
    [self.viewLastWeek addSubview:line];
    
    [line mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(WidthRate(20));
        make.height.mas_equalTo(1.5);
        make.right.mas_equalTo(WidthRate(-15));
        make.bottom.mas_equalTo(self.viewLastWeek.mas_bottom);
    }];
}
- (void)configCommpanyServerView{
    for (UIView *view in self.commpanyServersView.subviews) {
        [view removeFromSuperview];
    }
    for (int i = 0; i<self.commpanyServersArray.count; i++) {
        YHCommpanyServersModel *model = self.commpanyServersArray[i];
        UIView *backView = [[UIView alloc]init];
        backView.backgroundColor = [UIColor whiteColor];
        backView.layer.borderWidth = WidthRate(1.5);
        backView.layer.borderColor = SepratorLineColor.CGColor;
        backView.layer.cornerRadius = WidthRate(2);
        [self.commpanyServersView addSubview:backView];
        CGFloat width = (ScreenWidth-WidthRate(32))/3;
        [backView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.width.mas_equalTo(width);
            make.left.mas_equalTo(WidthRate(8)*(i+1)+i*width);
            make.height.mas_equalTo(HeightRate(42));
            make.centerY.mas_equalTo(self.commpanyServersView.mas_centerY);
        }];
        
        UIButton *btn = [UIButton buttonWithType:UIButtonTypeCustom];
        btn.tag = model.ServiceType;
        [btn addTarget:self action:@selector(goCommmpanyServersVC:) forControlEvents:UIControlEventTouchUpInside];
        [backView addSubview:btn];
        
        [btn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(0);
            make.top.mas_equalTo(0);
            make.right.mas_equalTo(0);
            make.bottom.mas_equalTo(0);
        }];
        
        UIImageView *imageIcon = [[UIImageView alloc]init];
        imageIcon.contentMode = UIViewContentModeScaleAspectFit;
        [imageIcon sd_setImageWithURL:[NSURL URLWithString:model.BrandServiceIcon]];
        [backView addSubview:imageIcon];
        
        [imageIcon mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(WidthRate(10));
            make.width.mas_equalTo(WidthRate(30));
            make.height.mas_equalTo(HeightRate(30));
            make.centerY.mas_equalTo(backView.mas_centerY);
        }];
        
        UILabel *title = [[UILabel alloc]init];
        title.text = model.BrandServiceTitle;
        title.font = SYSTEM_FONT(AdaptFont(13));
        [backView addSubview:title];

        [title mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.mas_equalTo(HeightRate(8));
            make.left.mas_equalTo(imageIcon.mas_right).offset(WidthRate(7));
        }];
        
        UILabel *titleDes = [[UILabel alloc]init];
        titleDes.text = model.BrandServiceDesc;
        titleDes.textColor = TextColor_666666;
        titleDes.font = SYSTEM_FONT(AdaptFont(9));
        [backView addSubview:titleDes];
        
        [titleDes mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.mas_equalTo(title.mas_bottom).offset(HeightRate(1));
            make.left.mas_equalTo(imageIcon.mas_right).offset(WidthRate(7));
        }];
        
    }
    if (self.commpanyServersArray.count == 1) {
        UIView *backView = [[UIView alloc]init];
        backView.backgroundColor = [UIColor whiteColor];
        backView.layer.borderWidth = WidthRate(1.5);
        backView.layer.borderColor = SepratorLineColor.CGColor;
        backView.layer.cornerRadius = WidthRate(2);
        [self.commpanyServersView addSubview:backView];
        [backView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_equalTo(WidthRate(-0));
            make.left.mas_equalTo(0);
            make.height.mas_equalTo(HeightRate(42));
            make.centerY.mas_equalTo(self.commpanyServersView.mas_centerY);
        }];
        
        UIButton *btn = [UIButton buttonWithType:UIButtonTypeCustom];
        [btn addTarget:self action:@selector(goTodayPriceVC) forControlEvents:UIControlEventTouchUpInside];
        [backView addSubview:btn];
        
        [btn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(0);
            make.top.mas_equalTo(0);
            make.right.mas_equalTo(0);
            make.bottom.mas_equalTo(0);
        }];
        
        UIImageView *imageIcon = [[UIImageView alloc]initWithImage:[UIImage imageNamed:@"dangrishoujia02"]];
        imageIcon.contentMode = UIViewContentModeScaleAspectFit;
        [backView addSubview:imageIcon];
        
        [imageIcon mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(WidthRate(10));
            make.width.mas_equalTo(WidthRate(30));
            make.height.mas_equalTo(HeightRate(30));
            make.centerY.mas_equalTo(backView.mas_centerY);
        }];
        
        UILabel *title = [[UILabel alloc]init];
        title.text = @"提供最新报价";
        title.font = SYSTEM_FONT(AdaptFont(13));
        [backView addSubview:title];
        
        [title mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.mas_equalTo(HeightRate(8));
            make.left.mas_equalTo(imageIcon.mas_right).offset(WidthRate(7));
        }];
        
        UILabel *titleDes = [[UILabel alloc]init];
        titleDes.text = @"相关产品最新报价";;
        titleDes.textColor = TextColor_666666;
        titleDes.font = SYSTEM_FONT(AdaptFont(9));
        [backView addSubview:titleDes];
        
        [titleDes mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.mas_equalTo(title.mas_bottom).offset(HeightRate(1));
            make.left.mas_equalTo(imageIcon.mas_right).offset(WidthRate(7));
        }];
    }
}
- (void)configLastWeekScroll{
    
    NSMutableArray *array = [NSMutableArray arrayWithCapacity:0];
    [array addObject:self.lastOrderArray[0]];
    [array addObject:self.lastOrderArray[1]];
    [array addObject:self.lastOrderArray[2]];
    HRAdView *adView = [[HRAdView alloc]initWithTitles:self.lastOrderArray];
    adView.time = 2.0f;
    [self.view addSubview:adView];
    if (array.count >1) {
        [adView beginScroll];
    }
    [adView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(0);
        make.right.mas_equalTo(0);
        make.top.mas_equalTo(self.viewLastWeek.mas_bottom);
        make.bottom.mas_equalTo(-49);
    }];
}
- (void)goSelectVC:(UIButton *)sender{
    if (phone.length<=0) {
        YHLoginViewController *loginViewController = [[YHLoginViewController alloc] init];
        loginViewController.navigationController.navigationBarHidden = YES;
        loginViewController.hidesBottomBarWhenPushed =YES;
        [self.navigationController pushViewController:loginViewController animated:YES];
        return;
    }
    switch (sender.tag) {
        case 1:{
                YHScanViewController *scan = [[YHScanViewController alloc] init];                scan.hidesBottomBarWhenPushed = YES;
                [self.navigationController pushViewController:scan animated:YES];
        }
            break;
        case 2:{
            YHMainMessageCenterViewController *vc = [[YHMainMessageCenterViewController alloc]init];
            vc.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:vc animated:YES];
        }
            break;
        case 3:{
            UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"Chat" bundle:nil];
            ChatNewViewController *vc = [storyboard instantiateViewControllerWithIdentifier:@"Chat"];
            vc.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:vc animated:YES];
        }
            break;
        default:
            break;
    }
}
- (void)goCommmpanyServersVC:(UIButton *)btn{
    switch (btn.tag) {
        case 1:{
           
            if (phone.length<=0) {
//                [self.view makeToast:@"请先去登录或注册" duration:.5 position:CSToastPositionCenter title:nil image:nil style:nil completion:^(BOOL didTap) {
                    YHLoginViewController *loginViewController = [[YHLoginViewController alloc] init];
                    loginViewController.navigationController.navigationBarHidden = YES;
                    loginViewController.hidesBottomBarWhenPushed =YES;
                    [self.navigationController pushViewController:loginViewController animated:YES];
//                }];/
                return;
            }
            BOOL isContue =   [self CertificationState];
            if (isContue == NO) {
                return;
                
            }
            YHBrandQulificationViewController *vc = [[YHBrandQulificationViewController alloc]init];
            vc.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:vc animated:YES];
        }
            break;
        case 2:{

            YHInsuranceSeviceViewController *vc = [[YHInsuranceSeviceViewController alloc]init];
            vc.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:vc animated:YES];
        }
            break;
        case 3:{
            

            YHAfterServersViewController *vc = [[YHAfterServersViewController alloc]init];
            vc.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:vc animated:YES];
        }
            break;
        case 4:{//订购流程
            
           
            YHCommonWebViewController *vc = [[YHCommonWebViewController alloc]init];

            vc.hidesBottomBarWhenPushed = YES;
            vc.titleName = @"订购流程";
            vc.time = WebTypeUserInstructions;
            vc.URLString = UserOrderinginfoURL;
            [self.navigationController pushViewController:vc animated:YES];
        }
            break;
        case 5:{//订购须知
            
       
            YHCommonWebViewController *vc = [[YHCommonWebViewController alloc]init];

            vc.hidesBottomBarWhenPushed = YES;
            vc.titleName = @"订购须知";
            vc.time = WebTypeUserInstructions;
            vc.URLString = UserOrderingproURL;
            [self.navigationController pushViewController:vc animated:YES];
        }
            break;
        default:
            break;
    }
}
- (void)getLastWeekData{
    
    [[YHJsonRequest shared] getuserLastweekOrder:^(NSDictionary *shoppingCartDict) {
        
        self.all_Prices = [shoppingCartDict objectForKey:@"all_price"];
        NSString *allPrice = [Tools getNsstringFromDouble:self.all_Prices.doubleValue isShowUNIT:NO];
        NSString *str = [NSString stringWithFormat:@"总额  ¥%@",allPrice];
        NSMutableAttributedString *AttributedStr = [[NSMutableAttributedString alloc]initWithString:str];
        [AttributedStr addAttribute:NSForegroundColorAttributeName value:ColorWithHexString(APP_THEME_MAIN_COLOR) range:NSMakeRange(3,str.length-3)];
        [AttributedStr addAttribute:NSFontAttributeName value:SYSTEM_FONT(AdaptFont(14)) range:NSMakeRange(3,str.length-3)];
        self.labelTotal.attributedText = AttributedStr;
        if ([shoppingCartDict objectForKey:@"party_list"]) {
            self.lastOrderArray = [shoppingCartDict objectForKey:@"party_list"];
            if (self.lastOrderArray.count >0) {
                [self configLastWeekScroll];
            }
            [self.view hideWait:CurrentView];
        }
    } fialureBlock:^(NSString *errorMessages) {
        [self.view hideWait:CurrentView];
        [self.view makeToast:errorMessages duration:1.0 position:CSToastPositionCenter];
        
    }];
}
- (void)getMainPageAdd{
    
    [[YHJsonRequest shared] getMainPageAddSuccessBlock:^(NSArray *mianImageAddArray) {
        [self.bannerImageGroup removeAllObjects];
        [self.bannerInstuition removeAllObjects];
        for (NSDictionary *dict in mianImageAddArray) {
            if (![dict objectForKey:@"ADUrl"]) {
                return;
            }
            [self.bannerImageGroup addObject:[dict objectForKey:@"ADUrl"]];
            [self.bannerInstuition addObject:[dict objectForKey:@"ADSkipLinkIos"]];
        }
        self.cycleview.imageURLStringsGroup = self.bannerImageGroup;
        if (self.bannerImageGroup.count>1) {
            self.cycleview.autoScroll = YES;
        }
    } fialureBlock:^(NSString *errorMessages) {
        [self.view makeToast:errorMessages duration:1.0 position:CSToastPositionCenter];
    }];
}
- (void)getCateGoryData{
    self.dataArray = [NSMutableArray array];
    self.category = [NSMutableDictionary dictionary];

    [[YHJsonRequest shared] getMainPageCategorySuccessBlock:^(NSDictionary *categoryDict) {
        self.dataArray = [categoryDict objectForKey:@"categorys"];
        self.category = [categoryDict objectForKey:@"main_category"];
        [self.collectionView reloadData];

    } fialureBlock:^(NSString *errorMessages) {
        [self.view makeToast:errorMessages duration:1.0 position:CSToastPositionCenter];
        [self.collectionView reloadData];

    }];

}
- (void)getCommpanyServerData{
    self.commpanyServersArray = [NSMutableArray arrayWithCapacity:0];
    [[YHJsonRequest shared] getBusinessServiceSuccessBlock:^(NSArray *listArray){
        self.commpanyServersArray = [NSMutableArray arrayWithArray:listArray];
        [self configCommpanyServerView];
    } fialureBlock:^(NSString *errorMessages) {
        [self.view makeToast:errorMessages duration:1.0 position:CSToastPositionCenter];
    }];
}

- (void)goTodayPriceVC{
    
    if (phone.length<=0) {
//        [self.view makeToast:@"请先去登录或注册" duration:0.5 position:CSToastPositionCenter title:nil image:nil style:nil completion:^(BOOL didTap) {
            YHLoginViewController *loginViewController = [[YHLoginViewController alloc] init];
            loginViewController.navigationController.navigationBarHidden = YES;
            loginViewController.hidesBottomBarWhenPushed =YES;
            [self.navigationController pushViewController:loginViewController animated:YES];
//        }];
        return;
    }
    self.tabBarController.selectedIndex = 1;
}

- (void)goSepacialPriceVC{
    
    if (phone.length<=0) {
//        [self.view makeToast:@"请先去登录或注册" duration:0.5 position:CSToastPositionCenter title:nil image:nil style:nil completion:^(BOOL didTap) {
            YHLoginViewController *loginViewController = [[YHLoginViewController alloc] init];
            loginViewController.navigationController.navigationBarHidden = YES;
            loginViewController.hidesBottomBarWhenPushed =YES;
            [self.navigationController pushViewController:loginViewController animated:YES];
//        }];
        return;
    }
    UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"Chat" bundle:nil];
    ChatNewViewController *vc = [storyboard instantiateViewControllerWithIdentifier:@"Chat"];
    vc.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:vc animated:YES];
}

//发现
- (void)goDiscoverNewsVC{
    
    YHDiscoverViewController *discover = [[YHDiscoverViewController alloc] init];
    discover.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:discover animated:YES];

}
#pragma mark---UICollectionViewDelegate & UICollectionViewDataSource
- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section{
    if (self.dataArray.count>=9) {
        return 10;
    }
    return self.dataArray.count+1;
}
- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath{
    if (self.dataArray.count <= 0) {
        UICollectionViewCell *cell =[collectionView dequeueReusableCellWithReuseIdentifier:@"LsatCategoryCell" forIndexPath:indexPath];
        if (!cell) {
            cell = [[UICollectionViewCell alloc]initWithFrame:CGRectMake(0, 0, WidthRate(47),  HeightRate(66))];
        }
        UIImageView *image = [[UIImageView alloc]init];
        [image sd_setImageWithURL:[NSURL URLWithString:[self.category objectForKey:@"BusinessCategoryIcon"]]];
        [cell.contentView addSubview:image];
        
        [image mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(0);
            make.right.mas_equalTo(0);
            make.top.mas_equalTo(0);
            make.bottom.mas_equalTo(0);
        }];
        return cell;
    }else{
        if (self.dataArray.count == indexPath.row) {
            UICollectionViewCell *cell =[collectionView dequeueReusableCellWithReuseIdentifier:@"LsatCategoryCell" forIndexPath:indexPath];
            if (!cell) {
                cell = [[UICollectionViewCell alloc]initWithFrame:CGRectMake(0, 0, WidthRate(47),  HeightRate(66))];
            }
            
            UIImageView *image = [[UIImageView alloc]init];
            [image sd_setImageWithURL:[NSURL URLWithString:[self.category objectForKey:@"BusinessCategoryIcon"]]];
            [cell.contentView addSubview:image];
            
            [image mas_makeConstraints:^(MASConstraintMaker *make) {
                make.left.mas_equalTo(0);
                make.right.mas_equalTo(0);
                make.top.mas_equalTo(0);
                make.bottom.mas_equalTo(0);
            }];
            return cell;
        }else{
            YHMainPageCategoryCell *cell =(YHMainPageCategoryCell *)[collectionView dequeueReusableCellWithReuseIdentifier:@"MainPageCategoryCell" forIndexPath:indexPath];
            if (!cell) {
                cell = [[YHMainPageCategoryCell alloc]initWithFrame:CGRectMake(0, 0, WidthRate(47),  HeightRate(60))];
            }
            [cell setData:self.dataArray[indexPath.item]];
            return cell;
        }
    }
}
- (CGSize)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout sizeForItemAtIndexPath:(NSIndexPath *)indexPath{
    
    return CGSizeMake(WidthRate(47), HeightRate(60));
}
- (CGFloat)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout minimumInteritemSpacingForSectionAtIndex:(NSInteger)section{
    
    return WidthRate(15);
}
- (CGFloat)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout minimumLineSpacingForSectionAtIndex:(NSInteger)section
{
    return HeightRateCommon(25);
}
- (UIEdgeInsets)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout insetForSectionAtIndex:(NSInteger)section
{
    return UIEdgeInsetsMake(HeightRate(10), WidthRate(20), HeightRate(0), WidthRate(20));
}
- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath{
    if (phone.length<=0) {
//        [self.view makeToast:@"请先去登录或注册" duration:0.5 position:CSToastPositionCenter title:nil image:nil style:nil completion:^(BOOL didTap) {
            YHLoginViewController *loginViewController = [[YHLoginViewController alloc] init];
            loginViewController.navigationController.navigationBarHidden = YES;
            loginViewController.hidesBottomBarWhenPushed =YES;
            [self.navigationController pushViewController:loginViewController animated:YES];
//        }];
        return;
    }
    if ([[[NSUserDefaults standardUserDefaults] objectForKey:LOGIN_USERCARDSTATE] isEqualToString:@"3"]){
        if ([[NSUserDefaults standardUserDefaults] stringForKey:USERSELECCATEGORY].length<=0||([[NSUserDefaults standardUserDefaults] stringForKey:USERSELECCATEGORY] == nil)){
            YHAlertView *alert = [[YHAlertView alloc]initWithDelegete:self Title:@"您还未选择经营品类，请在实名认证中提交"  leftButtonTitle:@"取消" rightButtonTitle:@"确定"];
            [alert showAnimated];
        }else{
            NSString *CATEGORY = [[NSUserDefaults standardUserDefaults] objectForKey:USERSELECCATEGORY];
            NSInteger index = [self.CategoryCode indexOfObject:CATEGORY];
            YHProductClassifyViewController *vc = [[YHProductClassifyViewController alloc]init];
            vc.serriesCode = self.CategoryCode[index];
            vc.titleName = self.CategoryData[index];
            vc.hidesBottomBarWhenPushed = YES;
            if (self.dataArray.count >0 && indexPath.item != self.dataArray.count) {
                NSString *CategoryId = [[self.dataArray objectAtIndex:indexPath.item] objectForKey:@"CategoryId"];
                vc.CategoryId = CategoryId;
            }
            [self.navigationController pushViewController:vc animated:YES];
        }
        
    }else{
        BOOL isContue =   [self CertificationState];
        if (isContue == NO) {
            return;
        }
    }
}
#pragma makk ---- YHAlertViewDelegate
- (void)alertViewRightBtnClick:(id)alertView{
    YHCertificationSuccessViewController *vc = [[YHCertificationSuccessViewController alloc] init];
    vc.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:vc animated:YES];
}

#pragma  mark -----SDCycleScrollViewDelegate
- (void)cycleScrollView:(SDCycleScrollView *)cycleScrollView didSelectItemAtIndex:(NSInteger)index{
    if (phone.length<=0) {
//        [self.view makeToast:@"请先去登录或注册" duration:0.5 position:CSToastPositionCenter title:nil image:nil style:nil completion:^(BOOL didTap) {
            YHLoginViewController *loginViewController = [[YHLoginViewController alloc] init];
            loginViewController.navigationController.navigationBarHidden = YES;
            loginViewController.hidesBottomBarWhenPushed =YES;
            [self.navigationController pushViewController:loginViewController animated:YES];
//        }];
        return;
    }
    BOOL isContue =   [self CertificationState];
    if (isContue == NO) {
        return;
    }
    if (self.bannerInstuition.count<=0) {
        return;
    }
    NSString *JsonString = [self.bannerInstuition objectAtIndex:index];
    NSData *jsonData = [JsonString dataUsingEncoding:NSUTF8StringEncoding];
    NSError *err;
    NSDictionary *dict = [NSJSONSerialization JSONObjectWithData:jsonData
                                                    options:NSJSONReadingMutableContainers
                                                           error:&err];
    if ([dict[@"className"] isEqualToString:@"YHTodayPriceViewController"]){
        self.tabBarController.selectedIndex = 1;
        return;
    }
    Class class = NSClassFromString(dict[@"className"]);
    UIViewController *vc = [[class alloc] init];
    // 获取参数列表，使用枚举的方式，对控制器属性进行KVC赋值
    NSDictionary *parameter = dict[@"propertys"];
    [parameter enumerateKeysAndObjectsUsingBlock:^(id  _Nonnull key, id  _Nonnull obj, BOOL * _Nonnull stop) {
        // 在属性赋值时，做容错处理，防止因为后台数据导致的异常
        if ([vc respondsToSelector:NSSelectorFromString(key)]) {
            [vc setValue:obj forKey:key];
        }
    }];
    vc.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:vc animated:YES];
    // 从字典中获取方法名，并调用对应的方法
    if (dict[@"method"]) {
        SEL selector = NSSelectorFromString(dict[@"method"]);
        [vc performSelector:selector];
    }
}
//判断审核状态
-(BOOL)CertificationState
{
    if (![[[NSUserDefaults standardUserDefaults] objectForKey:LOGIN_USERCARDSTATE] isEqualToString:@"3"])
    {
      NSString *state =  [[NSUserDefaults standardUserDefaults] objectForKey:LOGIN_USERCARDSTATE];
      if ([state isEqualToString:@"1"]) {
        YHCertificationStateOriginalViewController *vc = [[YHCertificationStateOriginalViewController alloc] init];
        vc.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:vc animated:YES];
        return NO;
      }else if ([state isEqualToString:@"2"]) {
        NSString *timeStr = [[NSUserDefaults standardUserDefaults] objectForKey:USERSTATECommitDate];
          
        YHCertificationStateViewController *vc = [[YHCertificationStateViewController alloc] init];
          vc.successDate = timeStr;
        vc.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:vc animated:YES];
        return NO;
      }else if ([state isEqualToString:@"4"]){
          
          NSString *resason =  [[NSUserDefaults standardUserDefaults] objectForKey:USERSTATEFailReason];
          YHCertificationStateViewController *vc = [[YHCertificationStateViewController alloc] init];
          vc.failReason = resason;
          vc.hidesBottomBarWhenPushed = YES;
          [self.navigationController pushViewController:vc animated:YES];
          return NO;

      }
    return YES;

  }
    return YES;
    
}

-(void)specilView:(UIView *)specilView tiltle:(NSString *)title othertiltle:(NSString *)othertiltle imageName:(NSString *)imageName isRight:(BOOL)isRight
{
    UIView *sepacialBgView = [[UIView alloc]init];
    sepacialBgView.backgroundColor = [UIColor whiteColor];
    sepacialBgView.layer.cornerRadius = HeightRate(17);
    sepacialBgView.layer.masksToBounds = YES;
    if (isRight==NO) {
         UITapGestureRecognizer *gesture = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(goSepacialPriceVC)];
        [sepacialBgView addGestureRecognizer:gesture];
    }else{
        UITapGestureRecognizer *gesture = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(goDiscoverNewsVC)];
        [sepacialBgView addGestureRecognizer:gesture];
    }
    [self.view addSubview:sepacialBgView];
    [sepacialBgView mas_makeConstraints:^(MASConstraintMaker *make) {
        if (isRight==YES) {
            make.right.mas_equalTo(-10);

        }else{
            make.left.mas_equalTo(10);
        }
        make.width.mas_equalTo(WidthRate(175));
        make.centerY.mas_equalTo(specilView.mas_centerY);
        make.height.mas_equalTo(HeightRate(34));
    }];
    
    UIImageView *sepacialImage = [[UIImageView alloc]initWithImage:[UIImage imageNamed:imageName]];
    sepacialImage.contentMode = UIViewContentModeScaleAspectFit;
    [sepacialBgView addSubview:sepacialImage];
    
    [sepacialImage mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(WidthRate(20));
        make.centerY.mas_equalTo(specilView.mas_centerY);
        make.width.mas_equalTo(WidthRate(20));
        make.height.mas_equalTo(HeightRate(20));
    }];
    
    
    UILabel *textLabelSepcail = [[UILabel alloc]init];
    textLabelSepcail.text = title;
    textLabelSepcail.font = [UIFont boldSystemFontOfSize:AdaptFont(12)];
    [sepacialBgView addSubview:textLabelSepcail];
    
    [textLabelSepcail mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(sepacialImage.mas_right).offset(WidthRate(5));
        make.centerY.mas_equalTo(specilView.mas_centerY);
    }];
    
    UILabel *textLabelSepcailDe = [[UILabel alloc]init];
    textLabelSepcailDe.text = othertiltle;
    textLabelSepcailDe.textColor = TextColor_666666;
    textLabelSepcailDe.font = [UIFont systemFontOfSize:AdaptFont(11)];
    [sepacialBgView addSubview:textLabelSepcailDe];
    
    [textLabelSepcailDe mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(textLabelSepcail.mas_right).offset(WidthRate(3));
        make.centerY.mas_equalTo(specilView.mas_centerY);
    }];
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
